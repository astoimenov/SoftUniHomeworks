<!doctype html>
<head>
	<meta charset="utf-8">
	<title>Countries</title>
	<meta name="description" content="Photo Album">
	<meta name="viewport" content="width=device-width">
	<link rel="stylesheet" href="css/reset.css">
	<link rel="stylesheet" href="css/styles.css">
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.3.1.min.js"></script>
</head>
<body>
	<h2>Countries</h2>
	<ul id="countries">
	</ul>
	<div id="towns" style="display:none">
		<h2>Towns</h2>
		<ul>
		</ul>
	</div>
	<script type="text/javascript">
		$(function() {
			var PARSE_APP_ID = "E1ZmmIAZCAY8o1z7523lUbwgvdTY3RFNTfuhbafi";
			var PARSE_REST_API_KEY = "Mh9LKEdFxjtZGic11jZL2HSAXewF9sc10eRvLpap";

			loadCountries();

			function loadCountries() {
				jQuery.ajax({
					method: "GET",
					headers: {
						"X-Parse-Application-Id": PARSE_APP_ID,
						"X-Parse-REST-API-Key": PARSE_REST_API_KEY
					},
					url: "https://api.parse.com/1/classes/Country",
					success: countriesLoaded
				});
			}

			function countriesLoaded(data) {
				for (var q in data.results) {
					var country = data.results[q];
					var countryItem = $('<li>');
					var countryLink = $("<a href='#'>").text(country.name);
					$(countryLink).data('country', country);
					countryLink.appendTo(countryItem);
					$(countryLink).click(countryClicked);
					countryItem.appendTo($("#countries"));
				}
			}

			function countryClicked() {
				var country = $(this).data('country');
				$("#towns").hide();
				$("#towns h2").text(country.name);
				var countryId = country.objectId;
				$.ajax({
					method: "GET",
					headers: {
						"X-Parse-Application-Id": PARSE_APP_ID,
						"X-Parse-REST-API-Key": PARSE_REST_API_KEY
					},
					url: 'https://api.parse.com/1/classes/Town?where={"country":{"__type":"Pointer","className":"Country","objectId":"' + countryId + '"}}',
					success: townsLoaded
				});
			}

			function townsLoaded(data) {
				$("#towns ul").html('');
				for (var a in data.results) {
					var town = data.results[a];
					var townItem = $('<li>');
					townItem.text(town.name);
					townItem.appendTo($("#towns ul"));
				}

				$('#towns').show();
			}
		});
	</script>
</body>
</html>